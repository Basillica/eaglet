<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Log Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Optional: Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Specific styles for log levels - THESE CLASSES APPLY COLORS */
        .log-trace { background-color: #f0f9ff; color: #0c4a6e; } /* sky-50, sky-900 */
        .log-debug { background-color: #f0fdf4; color: #166534; } /* emerald-50, emerald-800 */
        .log-info { background-color: #eff6ff; color: #1e40af; } /* blue-50, blue-800 */
        .log-warn { background-color: #fffbeb; color: #b45309; } /* amber-50, amber-800 */
        .log-error { background-color: #fef2f2; color: #b91c1c; } /* red-50, red-700 */
        .log-fatal { background-color: #fdf2f8; color: #be185d; } /* pink-50, pink-700 */
        .log-critical { background-color: #fef2f2; color: #7f1d1d; font-weight: bold; } /* red-50, red-900 */
    </style>
</head>
<body class="bg-gray-100 font-sans leading-normal tracking-normal">

    <div class="container mx-auto p-4">
        <header class="mb-6 bg-white shadow-md rounded-lg p-6">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">Log Dashboard</h1>
            <p class="text-gray-600">Visualize application logs intuitively.</p>
        </header>

        <div class="bg-white shadow-md rounded-lg p-6 mb-6 flex flex-wrap items-center gap-4">
            <div class="flex-grow">
                <label for="search" class="sr-only">Search Logs</label>
                <input type="text" id="search" placeholder="Search by message, service, or context..."
                       class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>

            <div class="flex-shrink-0">
                <label for="logLevel" class="sr-only">Log Level</label>
                <select id="logLevel" class="p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">All Levels</option>
                    <option value="critical">Critical</option>
                    <option value="fatal">Fatal</option>
                    <option value="error">Error</option>
                    <option value="warn">Warn</option>
                    <option value="info">Info</option>
                    <option value="debug">Debug</option>
                    <option value="trace">Trace</option>
                </select>
            </div>

            <div class="flex-shrink-0">
                <label for="serviceFilter" class="sr-only">Service</label>
                <select id="serviceFilter" class="p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">All Services</option>
                    <option value="frontend-app">frontend-app</option>
                    <option value="backend-api">backend-api</option>
                    <option value="auth-service">auth-service</option>
                    <option value="payment-gateway">payment-gateway</option>
                </select>
            </div>

            <button id="applyFilters" class="px-6 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                Apply Filters
            </button>
            <button id="clearFilters" class="px-6 py-3 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">
                Clear Filters
            </button>
        </div>

        <div id="logContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
            <p class="col-span-full text-center text-gray-500 p-8">Loading logs... If you see this for long, check your browser console for errors.</p>
        </div>

        <div class="text-center">
            <button id="loadMoreBtn" class="px-8 py-4 bg-green-600 text-white rounded-lg text-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                Load More Logs
            </button>
        </div>
    </div>

    <script>
        const logContainer = document.getElementById('logContainer');
        const searchInput = document.getElementById('search');
        const logLevelFilter = document.getElementById('logLevel');
        const serviceFilter = document.getElementById('serviceFilter');
        const applyFiltersBtn = document.getElementById('applyFilters');
        const clearFiltersBtn = document.getElementById('clearFilters');
        const loadMoreBtn = document.getElementById('loadMoreBtn');

        let allMockLogs = [];
        const PAGE_SIZE = 10;
        let currentPage = 0;

        const LOG_LEVELS = ['trace', 'debug', 'info', 'warn', 'error', 'fatal', 'critical'];
        const SERVICES = ['frontend-app', 'backend-api', 'auth-service', 'payment-gateway', 'reporting-service'];

        function getRandomElement(arr) {
            return arr[Math.floor(Math.random() * arr.length)];
        }

        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        /**
         * Generates a single mock log entry.
         * @returns {object} A mock LogEntry object.
         */
        function generateMockLog() {
            const level = getRandomElement(LOG_LEVELS);
            const service = getRandomElement(SERVICES);
            const timestamp = new Date().toISOString();
            const id = generateUUID();

            let message;
            let error_name = null;
            let stack = null;
            let reason = null;
            let request_method = null;
            let request_url = null;
            let status_code = null;
            let status_text = null;
            let error_message = null;

            switch (level) {
                case 'critical':
                    message = `Critical system failure in ${service}! Database connection lost.`;
                    error_name = 'DatabaseConnectionError';
                    stack = 'at db.js:100\n at server.js:50\n at app.js:10';
                    reason = { code: 500, detail: 'Failed to acquire DB lock' };
                    request_method = 'POST';
                    request_url = '/api/transactions';
                    status_code = 500;
                    status_text = 'Internal Server Error';
                    error_message = 'Failed to process transaction due to database issues.';
                    break;
                case 'fatal':
                    message = `Application crashed due to unhandled exception in ${service}.`;
                    error_name = 'UnhandledException';
                    stack = 'at process.js:20\n at main.js:10';
                    reason = { type: 'memory_leak', detail: 'Out of memory' };
                    break;
                case 'error':
                    message = `Failed to process request for user ${generateUUID()} on ${service}.`;
                    error_name = 'BadRequestError';
                    stack = 'at userController.js:45\n at routeHandler.js:20';
                    request_method = 'GET';
                    request_url = '/api/users/profile';
                    status_code = getRandomElement([400, 401, 403, 404, 500, 503]);
                    status_text = status_code === 400 ? 'Bad Request' : 'Service Unavailable';
                    error_message = 'Invalid input parameters for user profile.';
                    break;
                case 'warn':
                    message = `Deprecated API endpoint accessed in ${service}.`;
                    break;
                case 'info':
                    message = `User ${generateUUID()} logged in to ${service}.`;
                    break;
                case 'debug':
                    message = `Processing request for path /data in ${service}.`;
                    break;
                case 'trace':
                    message = `Entering function 'calculatePrice' in ${service}.`;
                    break;
            }

            const hasUser = Math.random() > 0.3; // 70% chance of having user info
            const userId = hasUser ? generateUUID() : undefined;
            const username = hasUser ? `user_${Math.random().toString(36).substring(7)}` : undefined;
            const email = hasUser ? `${username}@example.com` : undefined;

            const hasDevice = Math.random() > 0.5; // 50% chance of having device info
            const os_names = ['Windows', 'macOS', 'Linux', 'iOS', 'Android'];
            const browsers = ['Chrome', 'Firefox', 'Safari', 'Edge'];
            const device_info = hasDevice ? {
                os_name: getRandomElement(os_names),
                os_version: `${Math.floor(Math.random() * 10) + 10}.${Math.floor(Math.random() * 5)}`,
                brand: getRandomElement(['Apple', 'Samsung', 'Dell', 'HP', 'Google']),
                model: getRandomElement(['Pro', 'Air', 'Galaxy S20', 'Pixel 6', 'XPS']),
                user_agent: `Mozilla/5.0 (${getRandomElement(os_names)}) AppleWebKit/537.36 (KHTML, like Gecko) ${getRandomElement(browsers)}/100.0.1234.56 Chrome/100.0.0.0 Safari/537.36`
            } : undefined;

            const hasBreadcrumbs = Math.random() > 0.4; // 60% chance of having breadcrumbs
            const breadcrumbs = hasBreadcrumbs ? [
                { timestamp: new Date(new Date().getTime() - 5000).toISOString(), type: 'navigation', message: 'User navigated to /dashboard' },
                { timestamp: new Date(new Date().getTime() - 2000).toISOString(), type: 'click', message: 'Clicked "Save" button', data: { element: 'save-btn' } }
            ] : undefined;


            return {
                id,
                level,
                message,
                timestamp,
                service,
                context: {
                    component: "DashboardComponent",
                    sessionId: "abc-123-xyz",
                    userId: userId // Also add to context for demonstration
                },
                globalContext: {
                    environment: "development",
                    appVersion: "1.0.0"
                },
                userContext: hasUser ? {
                    country: "US",
                    deviceType: device_info?.os_name === 'iOS' || device_info?.os_name === 'Android' ? 'mobile' : 'desktop'
                } : null,
                user: hasUser ? { id: userId, username, email } : undefined,
                device: device_info,
                breadcrumbs: breadcrumbs,
                error_name: error_name,
                stack: stack,
                reason: reason,
                request_method: request_method,
                request_url: request_url,
                status_code: status_code,
                status_text: status_text,
                duration_ms: Math.random() > 0.5 ? Math.floor(Math.random() * 1000) : undefined,
                response_size: Math.random() > 0.5 ? Math.floor(Math.random() * 1024 * 10) : undefined,
                error_message: error_message,
            };
        }

        // This function now just returns the base class name (e.g., 'log-info')
        // Your CSS <style> block maps these classes to specific colors.
        function getLevelColorClass(level) {
            return `log-${level}`;
        }

        function renderLogEntry(log) {
            const logCard = document.createElement('div');
            // Apply the specific log-level class directly
            logCard.className = `log-entry p-4 rounded-lg shadow-sm border border-gray-200 ${getLevelColorClass(log.level)} relative overflow-hidden`;

            const timestamp = new Date(log.timestamp).toLocaleString();

            const jsonDetails = {
                id: log.id,
                context: log.context,
                globalContext: log.globalContext,
                userContext: log.userContext,
                user: log.user,
                device: log.device,
                breadcrumbs: log.breadcrumbs,
                error_name: log.error_name,
                stack: log.stack,
                reason: log.reason,
                request_method: log.request_method,
                request_url: log.request_url,
                status_code: log.status_code,
                status_text: log.status_text,
                duration_ms: log.duration_ms,
                response_size: log.response_size,
                error_message: log.error_message
            };

            logCard.innerHTML = `
                <div class="flex items-center justify-between mb-2">
                    <span class="text-xs font-semibold uppercase px-2 py-1 rounded-full ${getLevelColorClass(log.level)}">
                        ${log.level}
                    </span>
                    <span class="text-gray-500 text-sm">${timestamp}</span>
                </div>
                <h3 class="font-bold text-lg mb-1 ${getLevelColorClass(log.level).split(' ')[1] || 'text-gray-800'}">${log.message}</h3>
                <p class="text-sm text-gray-600 mb-2">Service: <span class="font-medium">${log.service}</span></p>

                ${log.error_name ? `<p class="text-red-700 text-sm">Error: <span class="font-medium">${log.error_name}</span></p>` : ''}
                ${log.error_message ? `<p class="text-red-700 text-sm">Error Message: <span class="font-medium">${log.error_message}</span></p>` : ''}
                ${log.request_url ? `<p class="text-gray-600 text-sm">Request: <span class="font-medium">${log.request_method || 'GET'} ${log.request_url}</span></p>` : ''}
                ${log.status_code ? `<p class="text-gray-600 text-sm">Status: <span class="font-medium">${log.status_code} ${log.status_text || ''}</span></p>` : ''}

                <div class="details-panel hidden p-2 mt-3 border-t border-gray-300 text-xs text-gray-700 max-h-48 overflow-y-auto">
                    <pre class="whitespace-pre-wrap font-mono text-[10px]">${JSON.stringify(jsonDetails, null, 2)}</pre>
                </div>
                <button class="toggle-details absolute bottom-2 right-2 px-3 py-1 bg-gray-200 text-gray-700 text-xs rounded-md hover:bg-gray-300">View Details</button>
            `;

            const toggleButton = logCard.querySelector('.toggle-details');
            const detailsPanel = logCard.querySelector('.details-panel');

            toggleButton.addEventListener('click', () => {
                detailsPanel.classList.toggle('hidden');
                toggleButton.textContent = detailsPanel.classList.contains('hidden') ? 'View Details' : 'Hide Details';
            });

            return logCard;
        }

        function displayLogs(logsToDisplay, append = false) {
            console.log(`Displaying ${logsToDisplay.length} logs (append: ${append}).`);
            if (!append) {
                logContainer.innerHTML = '';
            }
            if (logsToDisplay.length === 0) {
                logContainer.innerHTML = '<p class="col-span-full text-center text-gray-500">No logs found matching criteria.</p>';
                loadMoreBtn.classList.add('hidden');
                console.log("No logs to display or found after filtering.");
                return;
            }
            logsToDisplay.forEach(log => {
                const renderedCard = renderLogEntry(log);
                if (renderedCard) {
                    logContainer.appendChild(renderedCard);
                } else {
                    console.warn("renderLogEntry returned null/undefined for log:", log);
                }
            });
            loadMoreBtn.classList.toggle('hidden', logsToDisplay.length < PAGE_SIZE);
            console.log("Log cards appended to container.");
        }

        function filterLogs() {
            console.log("Filtering logs...");
            const searchTerm = searchInput.value.toLowerCase();
            const selectedLevel = logLevelFilter.value;
            const selectedService = serviceFilter.value;

            const filtered = allMockLogs.filter(log => {
                const matchesSearch = searchTerm === '' ||
                                      log.message.toLowerCase().includes(searchTerm) ||
                                      log.service.toLowerCase().includes(searchTerm) ||
                                      (log.error_name && log.error_name.toLowerCase().includes(searchTerm)) ||
                                      (log.error_message && log.error_message.toLowerCase().includes(searchTerm)) ||
                                      (log.context && JSON.stringify(log.context).toLowerCase().includes(searchTerm)) ||
                                      (log.user && log.user.username && log.user.username.toLowerCase().includes(searchTerm)) ||
                                      (log.user && log.user.email && log.user.email.toLowerCase().includes(searchTerm));

                const matchesLevel = selectedLevel === '' || log.level === selectedLevel;
                const matchesService = selectedService === '' || log.service === selectedService;

                return matchesSearch && matchesLevel && matchesService;
            });

            console.log(`Found ${filtered.length} logs after filtering.`);
            currentPage = 0;
            displayLogs(filtered.slice(0, PAGE_SIZE));
        }

        function loadMoreLogs() {
            console.log("Loading more logs...");
            currentPage++;
            const startIndex = currentPage * PAGE_SIZE;
            const filteredLogs = allMockLogs.filter(log => {
                const searchTerm = searchInput.value.toLowerCase();
                const selectedLevel = logLevelFilter.value;
                const selectedService = serviceFilter.value;

                const matchesSearch = searchTerm === '' ||
                                      log.message.toLowerCase().includes(searchTerm) ||
                                      log.service.toLowerCase().includes(searchTerm) ||
                                      (log.error_name && log.error_name.toLowerCase().includes(searchTerm)) ||
                                      (log.error_message && log.error_message.toLowerCase().includes(searchTerm)) ||
                                      (log.context && JSON.stringify(log.context).toLowerCase().includes(searchTerm)) ||
                                      (log.user && log.user.username && log.user.username.toLowerCase().includes(searchTerm)) ||
                                      (log.user && log.user.email && log.user.email.toLowerCase().includes(searchTerm));

                const matchesLevel = selectedLevel === '' || log.level === selectedLevel;
                const matchesService = selectedService === '' || log.service === selectedService;

                return matchesSearch && matchesLevel && matchesService;
            });
            const logsToAppend = filteredLogs.slice(startIndex, startIndex + PAGE_SIZE);
            console.log(`Attempting to append ${logsToAppend.length} more logs.`);
            displayLogs(logsToAppend, true);
        }

        applyFiltersBtn.addEventListener('click', filterLogs);
        clearFiltersBtn.addEventListener('click', () => {
            console.log("Clearing filters...");
            searchInput.value = '';
            logLevelFilter.value = '';
            serviceFilter.value = '';
            filterLogs();
        });
        loadMoreBtn.addEventListener('click', loadMoreLogs);

        // --- Core Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM Content Loaded: Starting log dashboard initialization.");
            
            // Generate mock logs
            for (let i = 0; i < 100; i++) { // Generate 100 logs
                allMockLogs.push(generateMockLog());
            }
            // Sort logs by timestamp descending (newest first)
            allMockLogs.sort((a, b) => new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime());

            console.log(`Generated ${allMockLogs.length} mock logs.`);
            console.table(allMockLogs.slice(0, 5)); // Show the first 5 logs in a table format in console

            // Display the first page of logs
            displayLogs(allMockLogs.slice(0, PAGE_SIZE));
            console.log("Initial page of mock logs requested for display.");
        });

    </script>
</body>
</html>